function e(e){const t=(t,...n)=>e.log(t,...n);function n(e){const t=new Set;return(e.match(/\b([a-zA-Z_$][a-zA-Z0-9_$]*(?:\.[a-zA-Z_$][a-zA-Z0-9_$]*)*)/g)||[]).forEach(e=>{const n=e.split(".");let o="";n.forEach(e=>{o=o?`${o}.${e}`:e,t.add(o)})}),Array.from(t)}return{digest:a,updateComponent:i,runWatchers:r,createWatcher:function(o,r,i){o.watcherRegistry||(o.watcherRegistry={});const s=n(r);let a,c=!0;const l=()=>{try{const n=e.evaluateExpression(r,o.scope);if(c||!e.isEqual(n,a)){const o=a;try{a=e.deepClone(n)}catch(e){a=n}try{i(n,o)}catch(e){t("error",`Error in watcher callback for '${r}':`,e)}return c=!1,!0}return c=!1,!1}catch(e){return t("error",`Error checking for changes in watcher '${r}':`,e),c=!1,!1}};s.forEach(e=>{o.watcherRegistry[e]||(o.watcherRegistry[e]=[]),o.watcherRegistry[e].includes(l)||o.watcherRegistry[e].push(l)});try{l()}catch(e){t("error",`Error during initial watcher run for '${r}':`,e)}return{expression:r,unwatch:()=>{s.forEach(e=>{if(o.watcherRegistry[e]){const t=o.watcherRegistry[e].indexOf(l);-1!==t&&o.watcherRegistry[e].splice(t,1)}})}}},renderComponent:function(n,o=null){if(!n||"object"!=typeof n)return void t("error","Invalid data for component rendering");if(o){const r=document.querySelector(o);if(!r)return void t("error",`Component not found: ${o}`);const i=e.elementToComponent.get(r)||e.components.get(r);if(i)return Object.assign(i.scope,n),void a(i)}e.components.forEach(e=>{Object.assign(e.scope,n)}),a()},destroyComponent:function t(n){if(e.virtualDOM.cleanupComponent(n),n.watcherRegistry={},n.childComponents.forEach(t),e.components.delete(n.element),e.elementToComponent.delete(n.element),n.parent){const e=n.parent.childComponents.indexOf(n);-1!==e&&n.parent.childComponents.splice(e,1)}},updateComponentTree:s,extractPropertyPaths:n};function o(t){const n={};t.inputProperties&&t.inputProperties.forEach(o=>{n[o]=e.deepClone(t.scope[o])});const o=e.virtualDOM.componentMap.get(t);if(o){e.virtualDOM.getScopeReferences(o).forEach(o=>{n[o]=e.deepClone(e.getNestedProperty(t.scope,o))})}return n}function r(e){let n=0,o=0;if(!e.watcherRegistry)return{watchersRun:n,changesDetected:o};const r=new Set;return Object.values(e.watcherRegistry).forEach(e=>{e.forEach(e=>{if(!r.has(e)){r.add(e);try{n++;e()&&o++}catch(e){t("error","Error in watcher:",e)}}})}),t("debug",`Ran ${n} watchers for component, ${o} changes detected`),{watchersRun:n,changesDetected:o}}function i(t){return"onPush"!==t.strategy||function(t){if("onPush"!==t.strategy)return!0;if(!t.previousInputs)return t.previousInputs=o(t),!0;const n=o(t),r=!e.isEqual(n,t.previousInputs);return r&&(t.previousInputs=n),r}(t)?r(t):{watchersRun:0,changesDetected:0}}function s(e){const t=i(e);return e.childComponents.forEach(e=>{const n=s(e);t.watchersRun+=n.watchersRun,t.changesDetected+=n.changesDetected}),t}function a(n=null){e.digestScheduled||(e.digestScheduled=!0,queueMicrotask(()=>{const o=performance.now();if(n){e.virtualDOM.updateComponent(n);s(n).changesDetected>0&&n.parent&&e.virtualDOM.updateComponent(n.parent)}else e.components.forEach(t=>{e.virtualDOM.updateComponent(t),i(t)});e.virtualDOM.applyChanges();const r=(performance.now()-o).toFixed(2);t("digest",`Digest cycle complete in ${r}ms`),e.digestScheduled=!1}))}}function t(e){const t=(t,...n)=>e.log(t,...n),n=new Map;return{parseCondition:function(e,n){try{return!!s(o(e),n)}catch(n){return t("error",`Error parsing condition '${e}':`,n),!1}},parseEventHandler:function(e,n,o){try{const r=Object.create(n);r.$event=o;const i=e.match(/^(\w+)\s*\((.*)\)$/);if(i){const e=i[1],o=i[2];if("function"==typeof n[e])try{const t=o.trim()?o.split(",").map(e=>s(e.trim(),r)):[];return n[e].apply(n,t),!0}catch(n){t("error",`Error calling function ${e}: ${n.message}`)}}const a={};for(const e in r)"string"!=typeof e||"$event"===e||e.startsWith(")")||(a[e]=r[e]);new Function("scope","event",`\n        with(scope) {\n          ${e};\n        }\n      `)(r,r.$event);let c=!1;for(const e in a)r[e]!==a[e]&&(n[e]=r[e],c=!0);return c||!0}catch(n){return t("error",`Error parsing event handler '${e}':`,n),!1}},executeExpression:function(e,n,o=null){try{const t=Object.keys(n).filter(e=>"string"==typeof e&&"$event"!==e&&!e.startsWith(")")),r=t.map(e=>`const _original_${e} = ${e};\n`).join(""),i=`return {\n        ${t.map(e=>`'${e}': (typeof ${e} !== 'undefined' && ${e} !== _original_${e}) ? ${e} : undefined`).join(",\n")}\n      }`,s=new Function("scope","event",`\n        try {\n          with(scope) {\n            ${r}\n            ${e};\n            ${i}\n          }\n        } catch(e) {\n          console.error("Error executing expression:", e);\n          throw e;\n        }\n      `)(n,n.$event);let a=!1;return o&&Object.entries(s||{}).forEach(([e,t])=>{void 0!==t&&o[e]!==t&&(o[e]=t,a=!0)}),a||!0}catch(n){return t("error",`Failed to execute expression: ${e}`,n),!1}},parseAttributeBindings:a,preprocessStrings:o,extractVariableNames:r,evaluateExpression:s,parseInterpolatedString:i,parseComplexExpression:function(e){const t=function(e){const t={hasTernary:!1,sections:[]};let n=!1,o="",r=0,i=-1,s=0;for(let a=0;a<e.length;a++){const c=e[a];'"'!==c&&"'"!==c||0!==a&&"\\"===e[a-1]||(n?c===o&&(n=!1):(n=!0,o=c)),n||("("===c?r++:")"===c&&r--,"?"===c&&0===r&&(i=a),":"===c&&-1!==i&&0===r&&(t.hasTernary=!0,t.sections.push({start:s,questionMark:i,colon:a,end:-1}),i=-1,s=a+1))}t.sections.length>0&&(t.sections[t.sections.length-1].end=e.length);return t}(e),n=/\w+\s*:/.test(e);if(t.hasTernary)return{type:"complex",expression:e.trim(),sections:t.sections};if(n)return{type:"object",pairs:a(e)};return{type:"simple",expression:e.trim()}},parseExpression:function(e,t){console.log("parseExpression",e,t);try{const n=i(e=e||"");let o="";for(const e of n)if(e.expression)try{const n=s(e.text,t);o+=null!=n?n:""}catch(t){console.error(`Error evaluating expression '${e.text}':`,t),o+=""}else o+=e.text;return o}catch(t){return console.error(`Error parsing expression '${e}':`,t),e}}};function o(e){return e.replace(/'((?:\\.|[^'\\])*)'/g,(e,t)=>`"${t.replace(/"/g,'\\"')}"`)}function r(e){const t=e.match(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\b/g)||[],n=["if","else","var","let","const","function","return","true","false","null","undefined","new","this"];return t.filter(e=>!n.includes(e))}function i(e){const t=[];let n,o=0;for(;-1!==(n=e.indexOf("{{",o));){n>o&&t.push({text:e.substring(o,n),expression:!1});const r=e.indexOf("}}",n+2);if(-1===r)break;t.push({text:e.substring(n+2,r).trim(),expression:!0}),o=r+2}return o<e.length&&t.push({text:e.substring(o),expression:!1}),t}function s(e,i){try{if(!n.has(e)){const t=o(e),r=new Function("scope",`\n          try {\n            with(scope) {\n              // Add safety checks for common undefined errors\n              const safeAccess = (obj, prop) => obj && obj[prop];\n              \n              // Extract potential object accesses to initialize safely\n              ${function(e){const t=/\b([a-zA-Z_$][a-zA-Z0-9_$]*(?:\.[a-zA-Z_$][a-zA-Z0-9_$]*)+)\b/g,n=e.match(t)||[];return[...new Set(n)].map(e=>{const t=e.split(".")[0];return`\n        // Initialize ${e} safely\n        let _${t}_exists = typeof ${t} !== 'undefined' && ${t} !== null;\n      `}).join("")}(t)}\n              \n              return ${t};\n            }\n          } catch(e) {\n            if (e instanceof ReferenceError) {\n              return undefined;\n            }\n            if (e instanceof TypeError && e.message.includes('undefined')) {\n              return undefined;\n            }\n            throw e;\n          }\n        `);n.set(e,r)}const t=n.get(e);return r(e).forEach(e=>{e in i||(i[e]=void 0)}),t(i)}catch(n){return t("error",`Error evaluating expression '${e}':`,n),""}}function a(e){try{const t=[];let n="",o="",r=!1,i=0,s=!1,a="",c=0;for(let l=0;l<e.length;l++){const d=e[l];'"'!==d&&"'"!==d||0!==l&&"\\"===e[l-1]||(s?d===a&&(s=!1):(s=!0,a=d)),s||("("===d&&i++,")"===d&&i--,"?"===d&&c++,":"===d&&c>0&&c--),":"!==d||r||s||0!==i||0!==c?","!==d||s||0!==i||0!==c?r?o+=d:n+=d:(n&&o&&t.push({attribute:n.trim(),expression:o.trim()}),n="",o="",r=!1):r=!0}return n&&o&&t.push({attribute:n.trim(),expression:o.trim()}),t}catch(n){return t("error",`Error parsing attribute bindings '${e}':`,n),[]}}}function n(e){const t=new Map,n=new Map;return function e(n){const o=n.querySelectorAll("[bind-repeat]");for(const n of o){const o=n.getAttribute("bind-repeat").match(/^\s*(?:(\w+),\s*(\w+)\s+in\s+|\s*(\w+)\s+in\s+)(.+)$/);if(!o)continue;const r=o[1]||o[3],i=o[2]||"$index",s=o[4].trim(),a=n.cloneNode(!0);a.removeAttribute("bind-repeat"),t.set(n,{itemName:r,indexName:i,arrayName:s,template:a}),e(a)}}(e),function(e){if(n.has(e))return n.get(e);const i=function(e){const t=[],n=e.split(".");for(const e of n){const n=e.match(/(.+)\[(\d+)\]/);n?t.push({name:n[1],isArray:!0,index:parseInt(n[2])}):t.push({name:e,isArray:!1})}return t}(e);if(1===i.length&&!i[0].isArray){const t=o(i[0].name);return t?(n.set(e,t),t):null}if(i[0].isArray){const o=i[0].name,s=i[0].index,a=Array.from(t.entries()).filter(([e,t])=>t.arrayName===o).map(([e])=>e);if(a.length>0){const o=i.slice(1).map(e=>e.name).join("."),c=function(e,n,o){const i=t.get(e);if(!i)return null;const s=`[bind="${i.itemName}.${o}"], [bind="${o}"]`,a=function(e){const t=function(e){if(!e.parentNode)return null;let t=e.parentNode.firstChild;for(;t;){if(t.nodeType===Node.COMMENT_NODE&&t.textContent.includes("bind-repeat"))return t;t=t.nextSibling}return null}(e);if(!t)return[];const n=[];let o=t.nextSibling;for(;o&&!r(o);)o.nodeType===Node.ELEMENT_NODE&&n.push(o),o=o.nextSibling;return n}(e);if(a.length<=n)return null;const c=a[n];return c.querySelector(s)}(a[0],s,o);if(c)return n.set(e,c),c}}return null};function o(t){const n=`[bind="${t}"]`;return e.querySelector(n)}function r(e){return e.nodeType===Node.COMMENT_NODE&&e.textContent.includes("bind-repeat")}}function o(e){if(!e)return null;if("checkbox"===e.type)return e.checked;if("number"===e.type||"range"===e.type){const t=Number(e.value);return isNaN(t)?0:t}return e.value}function r(e,t){if(e)if("checkbox"===e.type)e.checked=!!t;else if("radio"===e.type)e.checked=e.value===String(t);else if("SELECT"===e.tagName)if(e.value=t,e.value!==String(t)&&null!=t&&""!==t){const n=(e.__retry||0)+1;n<=3?(e.__retry=n,setTimeout(()=>r(e,t),10*n)):(delete e.__retry,console.warn(`Could not set select value to "${t}"`))}else delete e.__retry;else document.activeElement===e&&e.value===String(t??"")||(e.value=t??"")}function i(e){return e&&["INPUT","SELECT","TEXTAREA"].includes(e.tagName)}function s(e){if(!i(e))return null;const t={type:e.type||"text",value:o(e)};return"checkbox"!==e.type&&"radio"!==e.type||(t.checked=e.checked),"SELECT"===e.tagName&&(t.selectedIndex=e.selectedIndex,t.multiple=e.multiple),t}function a(e,t){if(!t||!t.nodeBindings)return!0;const n=t.nodeBindings.get(e);return!n||("checkbox"===e.type||"radio"===e.type?void 0===n.managedProps?.checked:void 0===n.managedProps?.value)}function c(e,t){if(e===t)return!0;if(null==e||null==t)return e===t;const n=typeof e;if(n!==typeof t)return!1;if("object"!==n)return e===t;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!c(e[n],t[n]))return!1;return!0}if(!Array.isArray(e)&&!Array.isArray(t)){const n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(const o of n)if(!t.hasOwnProperty(o)||!c(e[o],t[o]))return!1;return!0}return!1}function l(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>l(e));const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=l(e[n]));return t}function d(e,t){try{const n=t.split(".");let o=e;for(const e of n){if(null==o)return;o=o[e]}return o}catch(e){return void console.error(`Error getting nested property ${t}:`,e)}}function u(e){var t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style={position:"absolute",left:"-9999px"},document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}function p(e){const t=(t,...n)=>e.log(t,...n);let n=null,o=null,r=!1,i=!1,s=new Map,a=new Map;const c={title:"",size:"small",forceCloseButton:!1,showCloseButton:!0,showHeader:!0,animationDuration:300};function l(){r||(!function(){if(i)return;const e=document.createElement("style");e.textContent="\n  .dialog-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(0, 0, 0, 0.5);\n    z-index: 9000;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n  }\n  \n  .dialog-overlay-visible {\n    opacity: 1;\n  }\n  \n  .dialog-container {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%) scale(0.9);\n    background-color: #fff;\n    border-radius: 10px;\n    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);\n    z-index: 9001;\n    max-width: calc(100vw - 32px);\n    max-height: calc(100vh - 32px);\n    display: flex;\n    flex-direction: column;\n    opacity: 0;\n    transition: transform 0.3s ease, opacity 0.3s ease;\n    overflow: hidden;\n  }\n  \n  .dialog-container-visible {\n    opacity: 1;\n    transform: translate(-50%, -50%) scale(1);\n  }\n  \n  .dialog-small {\n    width: 400px;\n  }\n  \n  .dialog-medium {\n    width: 600px;\n  }\n  \n  .dialog-large {\n    width: 1200px;\n  }\n\n  .dialog-xl {\n    width: 1600px;\n    max-width: calc(100vw - 32px);\n  }\n  \n  .dialog-fullscreen {\n    width: calc(100vw - 32px);\n    height: calc(100vh - 32px);\n  }\n  \n  .dialog-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 16px;\n    border-bottom: 1px solid #e0e0e0;\n  }\n  \n  .dialog-title {\n    margin: 0;\n    font-size: 18px;\n    font-weight: 500;\n    color: #333;\n  }\n  \n  .dialog-close-btn {\n    background: none;\n    border: none;\n    font-size: 24px;\n    line-height: 1;\n    color: #666;\n    cursor: pointer;\n    padding: 0;\n    margin: 0;\n    width: 24px;\n    height: 24px;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    border-radius: 50%;\n    transition: background-color 0.2s;\n  }\n  \n  .dialog-close-btn:hover {\n    background-color: rgba(0, 0, 0, 0.1);\n    color: #333;\n  }\n  \n  .dialog-content {\n    flex: 1;\n    padding: 16px;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n  }\n  \n  .dialog-content > * {\n    width: 100%;\n  }\n  \n  .dialog-loading {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    height: 100px;\n    color: #666;\n    font-style: italic;\n  }\n    \n  .dialog-actions {\n    display: flex;\n    justify-content: flex-end;\n    gap: 10px;\n    margin-top: 24px;\n  }\n\n  /*\n  .btn {\n    padding: 8px 16px;\n    border-radius: 4px;\n    cursor: pointer;\n  }\n    \n  .btn-primary {\n    background-color: #3498db;\n    color: white;\n  }\n\n  .btn-secondary {\n    background-color: #e0e0e0;\n    color: #333;\n  }\n  */\n  \n  @media (max-width: 768px) {\n    .dialog-small, \n    .dialog-medium, \n    .dialog-large {\n      width: calc(100vw - 32px);\n    }\n    \n    .dialog-header {\n      padding: 12px;\n    }\n    \n    .dialog-content {\n      padding: 12px;\n    }\n  }\n",document.head.appendChild(e),i=!0}(),o||(o=document.createElement("div"),o.className="dialog-overlay",o.style.display="none",document.body.appendChild(o)),document.addEventListener("keydown",g),r=!0,a.set("confirm",function(e,{onSuccess:t,text:n}){e.continue=function(){t&&t(),e.closeDialog("confirmed")},e.text=n||"Are you sure you want to proceed?"}),s.set("confirm",'\n<div class="dialog dialog-medium" bind-function="confirmDialog" style="padding: 10px;">\n   <div>\n      {{text}}\n   </div>\n   <div class="dialog-actions">\n      <button on-click="closeDialog()" class="btn btn-secondary">Cancel</button>\n      <button on-click="continue()" class="btn btn-primary">Continue</button>\n   </div>\n</div>\n'))}function d(r,i={},a=null){if(l(),t("dialog",`Opening dialog: ${r}`),n&&"confirm"!==r)throw new Error(`Cannot open dialog '${r}' while another dialog is active`);let d={};"function"==typeof i?a=i:d=i,a&&(d.onSuccess=a);let g=null;return"confirm"===r&&n?g=n:n&&h(),function(t){const n=t.replace(/\\/g,"/");if("confirm"===n)return Promise.resolve(s.get("confirm"));if(s.has(n))return Promise.resolve(s.get(n));const o=[`${e.dialogsPath}/${n}/template.html`,`${e.dialogsPath}/${n}.html`];return r(0);function r(e){return e>=o.length?Promise.reject(new Error(`Failed to load dialog ${t}`)):fetch(o[e]).then(t=>t.ok?t.text().then(e=>(s.set(n,e),e)):r(e+1)).catch(()=>r(e+1))}}(r).then(t=>{const{parsed:i,html:s}=function(e){const t=e.match(/^\s*<dialog-config([^>]*)\/>\s*/i);if(!t)return{parsed:{},html:e};let n,o={};const r=t[1],i=/([a-z-]+)="([^"]*)"/gi;for(;null!==(n=i.exec(r));){const e=n[1].replace(/-([a-z])/g,(e,t)=>t.toUpperCase()),t=n[2];if(e in c){const n=typeof c[e];if("boolean"===n)o[e]="true"===t;else if("number"===n){const n=parseInt(t);isNaN(n)?console.warn(`Dialog config: '${e}' expects number, got '${t}'. Using default: ${c[e]}`):o[e]=n}else o[e]=t}else console.warn(`Dialog config: Unknown option '${e}'`)}return{parsed:o,html:e.substring(t[0].length)}}(t),a={...c,...i,...d};a.title||i.title||(a.title=r.replace(/[-_/\\]/g," ").replace(/\b\w/g,e=>e.toUpperCase()));const l=document.createElement("div");if(l.className=`dialog-container dialog-${a.size||"small"}`,l.dataset.dialogName=r,l.dataset.forceClose=a.forceCloseButton.toString(),"confirm"===r&&g&&(l.style.zIndex="9002"),a.showHeader){const e=document.createElement("div");if(e.className="dialog-header",a.title){const t=document.createElement("h2");t.className="dialog-title",t.textContent=a.title,e.appendChild(t)}if(a.showCloseButton){const t=document.createElement("button");t.className="dialog-close-btn",t.innerHTML="&times;",t.setAttribute("aria-label","Close dialog"),t.addEventListener("click",()=>f()),e.appendChild(t)}l.appendChild(e)}const h=document.createElement("div");h.className="dialog-content",l.appendChild(h),o.style.display="block",document.body.appendChild(l),o.addEventListener("click",m),n={container:l,content:h,name:r,options:a,resources:{js:[],css:[]},component:null,scope:{},previousDialog:g},function(t,o,r){r.innerHTML=t;const i=function(t){const n=t.lastIndexOf("/");if(-1===n)return`${e.dialogsPath}/${t}`;const o=t.substring(0,n),r=t.substring(n+1);return`${e.dialogsPath}/${o}/${r}`}(o.replace(/\\/g,"/")),s=function(e,t,o){const r=[];let i=!1;function s(t,o){const r=document.createElement("style");return r.textContent=t,r.dataset.dialogCss=e,r.dataset.cssSource=o,document.head.appendChild(r),n.resources.css.push(r),r}const a=t.querySelectorAll("style");a.length>0&&(i=!0,a.forEach((e,t)=>s(e.textContent,`embedded-${t}`)));const c=t.querySelectorAll('link[rel="stylesheet"]');c.length>0&&(i=!0,c.forEach((e,t)=>{const n=e.getAttribute("href");n&&r.push(fetch(n).then(e=>e.ok?e.text():null).then(e=>e&&s(e,`linked-${t}`)).catch(()=>{}))}));i||r.push(fetch(`${o}/style.css`).then(e=>e.ok?e.text():null).then(e=>e&&s(e,"external")).catch(()=>{}));return r}(o,r,i),a=function(e,t,n){const o=[];let r=!1;if("confirm"===e)return o;const i=t.querySelectorAll("script:not([src])");i.length>0&&(r=!0,i.forEach(t=>{t.textContent&&u(t.textContent,e),t.parentNode.removeChild(t)}));const s=t.querySelectorAll("script[src]");s.length>0&&(r=!0,s.forEach(t=>{const n=t.getAttribute("src");n&&(o.push(fetch(n).then(e=>e.ok?e.text():null).then(t=>t&&u(t,e)).catch(()=>{})),t.parentNode.removeChild(t))}));r||o.push(fetch(`${n}/script.js`).then(e=>e.ok?e.text():null).then(t=>t&&u(t,e)).catch(()=>{}));return o}(o,r,i);Promise.all([...s,...a]).then(()=>p(o,r)).catch(()=>p(o,r))}(s,r,h),setTimeout(()=>{o.classList.add("dialog-overlay-visible"),l.classList.add("dialog-container-visible")},10),setTimeout(()=>{l.focus();const e=l.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e&&e.focus()},50)}).catch(e=>{console.error("Failed to open dialog:",e)}),null}function u(e,n){try{const t=function(e){try{const t=e.trim(),n=/function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(([^)]*)\)\s*{/.exec(t);if(!n)throw new Error("No function declaration found in the script content");const o=n[1],r=n[2].split(",").map(e=>e.trim()),i=n.index,s=t.indexOf("{",i);if(-1===s)throw new Error(`Opening brace not found for function '${o}'`);let a=1,c=s+1;for(;a>0&&c<t.length;){const e=t[c];"{"===e?a++:"}"===e&&a--,c++}if(0!==a)throw new Error(`Function '${o}' appears to be incomplete - missing closing brace`);const l=t.substring(i,c);return{name:o,params:r,body:t.substring(s+1,c-1),fullFunction:l}}catch(e){throw e.message.includes("Function")?e:new Error(`Error extracting function: ${e.message}`)}}(e);if(t){const e=new Function("return ("+t.fullFunction+")")();a.set(n,e)}}catch(e){t("error","Error processing dialog script:",e)}}function p(o,r){function i(t){if(!e.initializeComponent)return null;const r=function(e){return a.has(e)?a.get(e):null}(o);if(!r)return null;const i=e.initializeComponent(t,r,n.options);return i&&i.scope&&n?(i.scope.closeDialog=e=>f(e),i.scope.getDialogContainer=()=>n.container,i.scope.getDialogOptions=()=>n.options,n.scope=i.scope,n.component=i,i):null}const s=r.querySelectorAll("[bind-function]");let c=null;if(0===s.length){const e=r.querySelector(".dialog")||r,t=`dialog_${o.replace(/[^a-zA-Z0-9]/g,"_")}`;e.setAttribute("bind-function",t),c=i(e)}else c=i(s[0]);c&&setTimeout(()=>{try{e.digest(c)}catch(e){t("error",`Digest error: ${e.message}`)}},0)}function f(t){if(!n)return;const o=n.options.forceCloseButton,r=e.notification?.error||console.warning;if(("escape-pressed"===t||"overlay-click"===t)&&o)return r("Dialog close button is required, but no result provided.");n.scope&&n.scope.onClose&&n.scope.onClose(),h()}function h(){if(!n)return;const e=!!("confirm"===n.name)&&n.previousDialog;n.container.classList.remove("dialog-container-visible"),n.container&&n.container.parentNode&&n.container.parentNode.removeChild(n.container),[...n.resources.js,...n.resources.css].forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),e?n=e:(o.classList.remove("dialog-overlay-visible"),o.removeEventListener("click",m),o.style.display="none",n=null)}function g(e){"Escape"===e.key&&n&&(e.preventDefault(),f("escape-pressed"))}function m(e){e.target===o&&f("overlay-click")}return l(),{open:d,close:f,clearCache:function(){s.clear(),a.clear()},confirm:function(e,t){return d("confirm",{text:e,onSuccess:t})}}}function f(e,t){let n={baseUrl:null,apiPath:"/api/",timeout:15e4,autoRefresh:!0,processRequest:e=>e,handleResponseStatus:{}};if(e.handleResponseStatus&&(n.handleResponseStatus={...n.handleResponseStatus,...e.handleResponseStatus},delete e.handleResponseStatus),e.setHeaderTokenFromStorage&&(n.processRequest=function(t){let n=e.setHeaderTokenFromStorage,o="string"==typeof n?n:"token";const r=localStorage.getItem(o);return r&&(t.headers[o]=r),t}),e.logoutOnDeniedPage){function c(t){localStorage.removeItem("token");let n="login.html";"string"==typeof e.logoutOnDeniedPage&&(n=e.logoutOnDeniedPage),window.location.href=n}n.handleResponseStatus[403]=c,n.handleResponseStatus[401]=c}function o(e,t){return r(e.method,e.url,e,t)}function r(e,t,n,r){return i(e,t=o.getApiUrl(t),n,r)}function i(e,t,o,r){if(!(t=t||""))throw new Error("No URL provided");"function"==typeof(o=o||{})&&(r=o,o={});let i=o.headers||{};if("POST"!==e&&"PUT"!==e&&"DELETE"!==e||(o.body||(o={body:o}),i["Content-Type"]="application/json"),"GET"===e&&o){const e={};for(const t in o){const n=o[t];e[t]="object"==typeof n&&null!==n?JSON.stringify(n):n}let n=new URLSearchParams(e).toString();n&&(t=t+"?"+n),i["Content-Type"]="application/json"}o.binary?i["Content-Type"]="application/octet-stream":o.body&&"string"!=typeof o.body&&(o.body=JSON.stringify(o.body));let a={method:e||"GET",url:t,headers:i,body:o.body||null,originalData:o};return"function"==typeof n.processRequest&&(a=n.processRequest(a)),new Promise(function(e,t){fetch(a.url,{method:a.method,headers:a.headers,body:a.body,signal:AbortSignal.timeout(n.timeout)}).then(e=>{if(s(),!e.ok)return e.text().then(o=>{let i=`HTTP error ${e.status}: ${o}`;e.statusText&&(i+=` (${e.statusText})`),r&&r(i),t(i);const s=n.handleResponseStatus[e.status];throw s&&setTimeout(()=>s(i),10),i});const i=e.headers.get("content-type")||"",a=o.responseType;return"blob"===a?e.blob():"arraybuffer"===a?e.arrayBuffer():"text"===a?e.text():i.includes("application/octet-stream")||i.includes("application/pdf")||i.includes("application/zip")||i.includes("application/vnd.ms-excel")||i.includes("application/vnd.openxmlformats")||i.includes("image/")||i.includes("video/")||i.includes("audio/")?e.blob():e.text()}).then(function(t){if(s(),"string"==typeof t)try{t=JSON.parse(t)}catch(e){}r&&r(null,t),e(t)}).catch(function(e){s(),console.error("HTTP Error:",e),r&&r(e),t(e)})})}function s(){try{n.autoRefresh&&n.refresh&&n.refresh()}catch(e){console.warn("Error refreshing UI:",e)}}function a(e){const t=e.lastIndexOf("."),n=t>0?e.substring(0,t):e,o=t>0?e.substring(t):"";let r=n.replace(/[\x00-\x1F\x7F]/g,"").replace(/[()<>@,;:\\"\/\[\]?={}]/g,"").replace(/\s+/g,"_").replace(/[\s\u00A0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]+/g,"_").replace(/[^\x20-\x7E]/g,"").replace(/^[\s.]+|[\s.]+$/g,"");r||(r="unnamed");const i=255-o.length;return r.length>i&&(r=r.substring(0,i)),r+o}return n={...n,...e},o.get=function(e,t){return r("GET",e,t)},o.post=function(e,t,n){return r("POST",e,t,n)},o.postFile=function(e,t,r,i,c){let l={showprogress:!0};"function"==typeof i?c=i:"object"==typeof i&&(l=i);e=o.getApiUrl(e);let d=Object.assign({},t||{});r instanceof Blob||(["extension","filename","mimetype","shortName"].forEach(e=>{r[e]&&(d[e]=r[e])}),console.log("postFile: file should be a Blob, but got:",d),r=new Blob([r.content],{type:d.mimetype||"application/octet-stream"}));d.filename&&(d.filename=a(d.filename));d.shortName&&(d.shortName=a(d.shortName));let u={method:"POST",url:e,headers:d};"function"==typeof n.processRequest&&(u=n.processRequest(u));d=u.headers,e=u.url;const p=new FormData;p.append("file",r,d.filename||"file");const f=new XMLHttpRequest;let h,g;if(l.showprogress){h=document.createElement("div"),h.style.cssText="position:fixed;top:0;left:0;width:100%;height:4px;z-index:9999;",g=document.createElement("div"),g.style.cssText="height:100%;width:0;transition:width 0.2s;";const e=getComputedStyle(document.documentElement).getPropertyValue("--main-color").trim()||"#ff0000";g.style.backgroundColor=e,h.appendChild(g),document.body.appendChild(h)}return f.upload.onprogress=function(t){if(t.lengthComputable){const n=Math.round(t.loaded/t.total*100);l.showprogress&&g&&(g.style.width=n+"%");const o=new CustomEvent("http:uploadProgress",{detail:{urlPath:e,percentComplete:n,loaded:t.loaded,total:t.total}});document.dispatchEvent(o)}},new Promise((t,n)=>{f.open("POST",e,!0),Object.keys(d).forEach(e=>{f.setRequestHeader(e,d[e])}),f.onload=function(){l.showprogress&&h&&setTimeout(()=>{document.body.removeChild(h)},500);let e={};try{e=f.responseText?JSON.parse(f.responseText):null}catch(e){console.error("Error in xhr.responseText:",f.responseText)}if(s(),f.status>=200&&f.status<300)"function"==typeof c&&c(null,e),t(e);else{const t=new Error(`Request failed with status ${f.status}`);t.response=e,"function"==typeof c&&c(t),n(t)}},f.onerror=function(){l.showprogress&&h&&document.body.removeChild(h);const e=new Error("Network error occurred");"function"==typeof c&&c(e),n(e)},f.send(p)})},o.put=function(e,t,n){return r("PUT",e,t,n)},o.delete=function(e,t,n){return r("DELETE",e,t,n)},o.getApiUrl=function(e){let t=o.getBaseUrl()+n.apiPath;return e&&(e.startsWith("/")&&(e=e.slice(1)),t+=e),t},o.getBaseUrl=function(){return n.baseUrl?n.baseUrl:o.getProtocol()+o.getCurrentDomain()},o.getProtocol=function(){return"localhost"===window.location.hostname?"http://":"https://"},o.getCurrentDomain=function(){const{hostname:e,port:t}=window.location;return`${e}${t?`:${t}`:""}`},o.httpSend=i,o.getConfig=()=>n,o.onUploadProgress=function(e,t){const n=function(n){e&&n.detail.urlPath!==e||t(n.detail)};return document.addEventListener("http:uploadProgress",n),function(){document.removeEventListener("http:uploadProgress",n)}},o}const h=function(){let e=[],t=!1;function n(n){!function(){if(t)return;const e=document.createElement("style");e.textContent="\n       .notification-container {\n         position: fixed;\n         top: 50px;\n         left: 50%;\n         transform: translateX(-50%);\n         padding: 10px 20px;\n         color: white;\n         border-radius: 4px;\n         box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n         z-index: 10000;\n         cursor: pointer;\n         text-align: center;\n         min-width: 200px;\n         max-width: 90%;\n       }\n     ",document.head.appendChild(e),t=!0}(),"object"!=typeof n&&(n={content:n,type:o||"info"});let o=n.type||"info";const r="error"===o?"red":"warning"===o?"#ff9800":"info"===o?"#2196F3":"#4CAF50",i=document.createElement("div");i.className=`notification notification-${o} notification-container`,i.textContent=n.content,i.style.backgroundColor=r,i.style.top="-100px",i.style.opacity="0",i.style.transition="all 0.3s ease-in-out";const s=Date.now()+Math.random().toString(36).substr(2,5);function a(){let t=20;e.forEach(e=>{const n=e.element,o=n.offsetHeight||50;n.style.top=`${t}px`,n.style.transform="translateX(-50%)",t+=o+10})}function c(t){const n=e.findIndex(e=>e.id===t);if(-1===n)return;const o=e[n];clearTimeout(o.timer),o.element.style.opacity="0",o.element.style.transform="translateY(-20px) translateX(-50%)",setTimeout(()=>{o.element.parentNode&&o.element.parentNode.removeChild(o.element),e.splice(n,1),a()},300)}return i.dataset.notificationId=s,console.log(`%cNotification: ${o} - ${n.content}`,`color: ${r}; font-weight: bold;`),document.body.appendChild(i),e.push({element:i,id:s,timer:setTimeout(()=>c(s),5e3)}),a(),i.addEventListener("click",()=>c(s)),setTimeout(()=>{i.style.opacity="1"},10),s}function o(e){return function(...t){let o;return o=t.length>1?t.join(" "):t[0],"string"==typeof o&&(o={content:o}),o.type=e,n(o)}}return{show:n,success:function(...e){return o("success")(...e)},error:function(...e){return o("error")(...e)},warning:function(...e){return o("warning")(...e)},info:function(...e){return o("info")(...e)},dismissAll:function(){[...e].forEach(t=>{const n=t.id;clearTimeout(t.timer),t.element.style.opacity="0",t.element.style.transform="translateY(-20px) translateX(-50%)",setTimeout(()=>{t.element.parentNode&&t.element.parentNode.removeChild(t.element);const o=e.findIndex(e=>e.id===n);-1!==o&&e.splice(o,1)},300)})}}}(),g=function(){const e="lightbind-storage-";const t=function(){try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}();function n(t){return`${e}${t}`}return t||console.warn("localStorage is not available. LightBindStorage will not persist data."),{set:function(e,o){if(!t||!e)return!1;try{const t="string"==typeof o?o:JSON.stringify(o);return localStorage.setItem(n(e),t),!0}catch(e){return console.error("Error storing data:",e),!1}},get:function(e,o=null){if(!t||!e)return o;try{const t=localStorage.getItem(n(e));if(null===t)return o;try{return JSON.parse(t)}catch{return t}}catch(e){return o}},remove:function(e){if(!t||!e)return!1;try{return localStorage.removeItem(n(e)),!0}catch(e){return!1}},clear:function(){if(!t)return!1;try{const t=[];for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);o&&o.startsWith(e)&&t.push(o)}return t.forEach(e=>localStorage.removeItem(e)),!0}catch(e){return!1}},has:function(e){if(!t||!e)return!1;try{return null!==localStorage.getItem(n(e))}catch{return!1}},PREFIX:e}}();function m(e={}){const t={element:e.element||null,type:e.type||"element",component:e.component||null,scope:e.scope||(e.component?e.component.scope:null),value:null,isDirty:!1,isRemoved:!1,parent:e.parent||null,watchers:[]};return"text"===t.type&&e.textData?t.value=e.textData:"element"===t.type&&e.element&&(t.value=s(e.element)),t}const y={create:m,clone:function(e){if(!e)return null;const t=m({element:null,component:e.component,scope:e.scope,parent:null});if(e.value)try{t.value=JSON.parse(JSON.stringify(e.value))}catch(n){t.value={...e.value}}return t},applyToDom:function(e){if(e.element&&e.isDirty)if(e.isRemoved)e.element.parentNode&&e.element.parentNode.removeChild(e.element);else{if("text"===e.type&&e.value&&void 0!==e.value.lastValue)return e.element.nodeValue=e.value.lastValue,void(e.isDirty=!1);e.value&&a(e.element,e.component)&&r(e.element,e.value.value),e.isDirty=!1}},removeFromDOM:function(e){e.element&&e.element.parentNode&&(e.element.parentNode.removeChild(e.element),e.isRemoved=!0)},getElementValue:s};function b(e){const t={nodeMap:new WeakMap,componentMap:new Map,textNodeMap:new Map};return t.createFromDOM=function(e,n){if(!e||t.nodeMap.has(e))return t.nodeMap.get(e);let o=null;return n&&e===n.element?(o=y.create({element:e,component:n,scope:n.scope}),t.nodeMap.set(e,o),t.componentMap.set(n,o)):i(e)&&(o=y.create({element:e,component:n,scope:n.scope}),t.nodeMap.set(e,o)),e.children?.length>0&&Array.from(e.children).forEach(e=>t.createFromDOM(e,n)),o},t.updateComponent=function(n){n&&n.element.querySelectorAll("input, select, textarea").forEach(o=>{let r=t.nodeMap.get(o);r||(r=y.create({element:o,component:n,scope:n.scope}),t.nodeMap.set(o,r));const i=r.value||{},a=s(o);e.isEqual(i,a)||(r.value=a,r.isDirty=!0)})},t.applyChanges=function(){t.componentMap.forEach((e,n)=>{n?.element&&n.element.querySelectorAll("input, select, textarea").forEach(e=>{const n=t.nodeMap.get(e);n?.isDirty&&(y.applyToDom(n),n.value&&n.component&&a(e,n.component)&&function(e,t){const n=e.getAttribute("bind");n&&t&&(t[n]=o(e))}(e,n.component.scope))})}),t.textNodeMap.forEach((e,t)=>{e.isDirty&&y.applyToDom(e)})},t.getVirtualNode=function(e){return t.nodeMap.get(e)},t.processTextNodes=function(n,o){if(!n||!o)return;const r=n=>{if(n.nodeType===Node.TEXT_NODE&&n.nodeValue.includes("{{")){const r=e.parseInterpolatedString(n.nodeValue);if(r.some(e=>e.expression)){const i={originalValue:n.nodeValue,parts:r,lastValue:null},s=y.create({element:n,type:"text",component:o,scope:o.scope,textData:i});t.textNodeMap.set(n,s);const a=()=>{let t="";r.forEach(n=>{if(n.expression){const r=e.evaluateExpression(n.text,o.scope);let i="";if(null===r)i="null";else if(void 0===r)i="";else if("object"==typeof r)try{i=JSON.stringify(r)}catch(e){i=String(r)}else i=String(r);t+=i}else t+=n.text}),s.value.lastValue!==t&&(s.value.lastValue=t,s.isDirty=!0,null!==s.value.lastValue&&(n.nodeValue=t))};r.filter(e=>e.expression).forEach(t=>{e.createWatcher(o,t.text,a)}),a(),s.isDirty&&null!==s.value.lastValue&&(n.nodeValue=s.value.lastValue,s.isDirty=!1)}}},i=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t&&function(e){const t=["bind-if","bind-repeat","bind-component","bind-html"];return Array.from(e.attributes||[]).some(e=>t.includes(e.name))}(t)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let s;for(;s=i.nextNode();)r(s)},t.cleanupComponent=function(e){if(e&&(t.componentMap.delete(e),e.element)){t.nodeMap.delete(e.element),e.elements?.forEach(e=>{e&&t.nodeMap.delete(e)}),e.element.querySelectorAll?.("input, select, textarea").forEach(e=>{t.nodeMap.delete(e)});const n=document.createTreeWalker(e.element,NodeFilter.SHOW_TEXT);let o;for(;o=n.nextNode();)t.textNodeMap.delete(o)}},t}class v{constructor(e){if(new.target===v)throw new Error("BaseDirective cannot be instantiated directly");this.lightBind=e}process(e,t,n){throw new Error("process() must be implemented by subclasses")}log(e,...t){this.lightBind.debug&&this.lightBind.log(e,`[${this.constructor.name}]`,...t)}}class x extends v{process(e,t,n){const o=this.lightBind.parseComplexExpression(t);return"object"===o.type?o.pairs.forEach(t=>{const{attribute:o,expression:r}=t;this.lightBind.createWatcher(n,r,t=>{n.updateProperty(e,o,t)})}):(this.log("warn","bind-attr should be an object",t),this.lightBind.createWatcher(n,t,t=>{try{"object"==typeof t&&null!==t&&Object.entries(t).forEach(([t,o])=>{n.updateProperty(e,t,o)})}catch(e){this.log("error","Error setting attributes",e)}})),{success:!0}}}class E extends v{process(e,t,n){this.log("debug",`Processing bind-class: ${t}`);const o=this.findOwnerComponent(e,n),r=o?o.scope:n.scope,i=e.getAttribute("class")||"";n.nodeBindings.has(e)||n.nodeBindings.set(e,{});const s=n.nodeBindings.get(e);s.originalClasses=i;const a=()=>{try{const o=this.lightBind.evaluateExpression(t,r);let i="";"string"==typeof o?i=o:"object"==typeof o&&null!==o&&(i=Object.entries(o).filter(([e,t])=>t).map(([e])=>e).join(" "));const a=this.combineClasses(s.originalClasses,i);n.updateProperty(e,"class",a)}catch(e){this.log("error",`Error updating classes for ${t}:`,e)}};return this.lightBind.createWatcher(o||n,t,a),a(),{success:!0}}combineClasses(e,t){if(!e&&!t)return"";if(!e)return t;if(!t)return e;const n=e.split(/\s+/).filter(e=>e.length>0),o=t.split(/\s+/).filter(e=>e.length>0),r=new Set([...n,...o]);return Array.from(r).join(" ")}findOwnerComponent(e,t){for(const t of this.lightBind.components.values())if(t.isRepeatItem&&t.elements&&(t.elements.includes(e)||t.element&&t.element.contains(e)))return t;if(this.lightBind.elementToComponent.has(e))return this.lightBind.elementToComponent.get(e);let n=e.parentElement;for(;n;){if(this.lightBind.elementToComponent.has(n))return this.lightBind.elementToComponent.get(n);if(n===t.element)break;n=n.parentElement}return t}}class w extends v{constructor(e){super(e),this.templateCache=new Map}process(e,t,n){const o=this.lightBind.evaluateExpression(t,n.scope);if(!o)return this.log("error",`Invalid component name: ${t}`),{success:!1};const r=e.getAttribute("data");let i={};return r&&(i=this.lightBind.evaluateExpression(r,n.scope)||{}),n.nodeBindings.has(e)||n.nodeBindings.set(e,{}),n.nodeBindings.get(e).componentProcessed=!0,this.loadComponent(o,e,i,n),{success:!0,skipChildren:!0}}async loadComponent(e,t,n,o){try{const r=await this.getComponentTemplate(e);t.innerHTML=r;const i=`${e.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}_${Math.floor(1e3*Math.random())}`,s=t.querySelector("template");if(s){const r=s.getAttribute("bind-function"),a=s.innerHTML;if(t.innerHTML="",r&&t.setAttribute("bind-function",r),t.setAttribute("data-component-id",i),t.setAttribute("data-component-name",e),t.innerHTML=a,this.processComponentStyles(e,s),r){const e=this.lightBind.initializeComponent(t);return e&&e.scope&&(Object.assign(e.scope,n),this.lightBind.digest(e)),e}this.lightBind.processElementAndChildren(t,o)}else{const e=t.querySelector("[bind-function]");if(e){const t=this.lightBind.initializeComponent(e);return t&&t.scope&&(Object.assign(t.scope,n),this.lightBind.digest(t)),t}this.lightBind.processElementAndChildren(t,o)}}catch(n){return this.log("error",`Error loading component ${e}:`,n),t.innerHTML=`<div class="component-error">Error loading component: ${e}</div>`,null}}processComponentStyles(e,t){const n=this.lightBind.componentsPath||"./components",o=t.querySelectorAll("style");for(const t of o){const n=`lb-component-style-${e.replace(/[^a-zA-Z0-9]/g,"_")}`;if(!document.getElementById(n)){const e=document.createElement("style");e.id=n,e.textContent=t.textContent,document.head.appendChild(e)}}const r=t.querySelectorAll('link[rel="stylesheet"]');for(const t of r){const o=t.getAttribute("href");if(o){const t=o.startsWith("http")||o.startsWith("/")?o:`${n}/${e}/${o}`,r=`lb-component-link-${t.replace(/[^\w]/g,"_")}`;if(!document.getElementById(r)){const e=document.createElement("link");e.id=r,e.rel="stylesheet",e.href=t,document.head.appendChild(e)}}}}async getComponentTemplate(e){if(this.templateCache.has(e))return this.templateCache.get(e);try{const t=e.replace(/\\/g,"/"),n=this.lightBind.componentsPath||"./components",o=[`${n}/${t}/template.html`,`${n}/${t}/component.html`];let r;for(const e of o)try{if(r=await fetch(e),r.ok)break}catch(e){}if(!r||!r.ok)throw new Error(`Component not found: ${e}`);const i=await r.text();return this.templateCache.set(e,i),i}catch(t){throw this.log("error",`Failed to load component template: ${e}`,t),t}}clearCache(){this.templateCache.clear()}}class $ extends v{process(e,t,n){this.lightBind.log("debug",`Setting up bind-drag: ${t}`),console.warn(e.hasAttribute("draggable")),e.hasAttribute("draggable")||(console.warn("Element is not draggable. Setting draggable attribute to true."),e.setAttribute("draggable","true"));let o=e.getAttribute("index"),r=e.getAttribute("name");return e.addEventListener("dragstart",i=>{i.dataTransfer.clearData("text"),i.dataTransfer.effectAllowed="move";const s={};t&&("function"==typeof n.scope[t]?s.data=n.scope[t]():s.data=this.lightBind.evaluateExpression(t,n.scope)),o&&(s.index=this.lightBind.evaluateExpression(o,n.scope)),r&&(s.name=this.lightBind.evaluateExpression(r,n.scope)),i.dataTransfer.setData("text",JSON.stringify(s)),e.classList.add("dragging")}),e.addEventListener("dragend",()=>{e.classList.remove("dragging")}),{success:!0}}}class C extends v{process(e,t,n){this.lightBind.log("debug",`Setting up bind-drop: ${t}`);const o=e.getAttribute("drop-data");return e.addEventListener("drop",r=>{r.preventDefault();const i=JSON.parse(r.dataTransfer.getData("text"));o&&(i.dropData=this.lightBind.evaluateExpression(o,n.scope)),i&&t&&n.scope[t]&&(n.scope[t](i),this.lightBind.digest(n)),e.classList.remove("dragover")}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),{success:!0}}}class N extends v{process(e,t,n){this.log("dom",`Setting up HTML binding for element with "${t}"`),this.lightBind.createWatcher(n,t,n=>{try{e.innerHTML=null!=n?n:"",this.log("dom",`Updated HTML content for "${t}" with:`,n)}catch(e){this.log("error",`Error updating HTML content with ${t}:`,e)}}),n.nodeBindings.has(e)||n.nodeBindings.set(e,{});return n.nodeBindings.get(e).htmlBinding={expression:t},this.log("dom",`HTML binding established for "${t}"`),{success:!0}}}class A extends v{process(e,t,n){const o=e.parentNode,r=document.createComment(`bind-if: ${t}`),i=e.cloneNode(!0);i.removeAttribute("bind-if"),o.insertBefore(r,e),o.removeChild(e);const s={isVisible:!1,instance:null};return this.lightBind.createWatcher(n,t,e=>{const t=!!e;if(s.isVisible!==t){if(this.log("debug",`bind-if visibility changed to ${t}`),t){const e=i.cloneNode(!0);o.insertBefore(e,r.nextSibling),s.instance=e,this.log("debug","Processing newly shown bind-if content"),this.lightBind.processElementAndChildren(e,n),this.log("debug","Processing text bindings in conditionally visible element"),this.lightBind.virtualDOM.processTextNodes(e,n),queueMicrotask(()=>{this.lightBind.digest(n)})}else s.instance&&s.instance.parentNode&&(o.removeChild(s.instance),s.instance=null);s.isVisible=t}else t&&s.instance&&queueMicrotask(()=>{this.lightBind.digest(n)})}),{success:!0,skipChildren:!0}}}class T extends v{proxyArrayMethods(e,t,n){if(!e||!Array.isArray(e)||e.__methodsProxied)return e;return["splice","push","pop","shift","unshift","sort","reverse"].forEach(n=>{const o=e[n];"function"==typeof o&&(e[n]=function(...e){const n=o.apply(this,e);return t&&t.scope&&"function"==typeof t.scope.$refresh&&setTimeout(()=>t.scope.$refresh(),0),n})}),e.__methodsProxied=!0,this.log("debug",`Proxied mutation methods for array ${n}`),e}createRepeatItemComponent(e,t,n,o,r){const i=this;this.log("debug",`Creating repeat item component for index ${o}`);const s={element:e,scope:t,bindings:[],watcherRegistry:{},childComponents:[],parent:n,nodeBindings:new WeakMap,isRepeatItem:!0,repeatIndex:o,repeatId:r,elements:[e],updateProperty:function(e,t,n){this.nodeBindings.has(e)||this.nodeBindings.set(e,{});const o=this.nodeBindings.get(e);return o.managedProps||(o.managedProps={}),o.managedProps[t]=n,"class"===t?e.className=n:"style"===t&&"object"==typeof n?Object.entries(n).forEach(([t,n])=>{e.style[t]=n}):"value"===t?("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName)&&(e.value=n):"checked"===t&&"INPUT"===e.tagName?e.checked=!!n:e.setAttribute(t,n),this},destroy:function(){if(this.parent&&this.parent.childComponents){const e=this.parent.childComponents.indexOf(this);-1!==e&&this.parent.childComponents.splice(e,1)}i.lightBind.components.delete(this.element),i.lightBind.elementToComponent.delete(this.element),i.lightBind.virtualDOM&&i.lightBind.virtualDOM.cleanupComponent(this),this.watcherRegistry={},this.nodeBindings=new WeakMap}};return s}process(e,t,n){this.log("debug",`Starting bind-repeat for: ${t}`);const o=t.match(/^\s*(?:(\w+),\s*(\w+)\s+in\s+|\s*(\w+)\s+in\s+)(.+?)(?:\s+track\s+by\s+(.+))?$/),r=t.match(/^\s*\((\w+),\s*(\w+)\)\s+in\s+(.+?)(?:\s+track\s+by\s+(.+))?$/);if(!o&&!r)return this.log("error",`Invalid bind-repeat syntax: ${t}`),{success:!1,skipChildren:!1};let i,s,a,c,l;o?(i=o[1]||o[3],s=o[2]||"$index",a=o[4],c=o[5],l=!1):(s=r[1],i=r[2],a=r[3],c=r[4],l=!0),this.log("debug",`Parsing: itemName=${i}, indexName=${s}, itemsExpr=${a}, trackBy=${c}`);const d=a.trim(),u=n.scope[d];Array.isArray(u)&&this.proxyArrayMethods(u,n,d);const p=e.parentNode,f=e.cloneNode(!0);f.removeAttribute("bind-repeat");const h=e.getAttribute("filter"),g=e.getAttribute("sort");h&&f.removeAttribute("filter"),g&&f.removeAttribute("sort");const m={parent:p,template:f,instances:[],element:e,repeatId:`repeat_${Date.now()}_${Math.random()}`,itemName:i,indexName:s,isObjectIteration:l};return p.removeChild(e),n._repeatStates||(n._repeatStates=[]),n._repeatStates.push(m),this.lightBind.createWatcher(n,a,e=>{let t;if(this.log("debug",`Watcher triggered for ${a}: ${e?Array.isArray(e)?e.length:"not array":"undefined"} items`),null==e&&(this.log("debug",`Warning: Expression "${a}" returned ${void 0===e?"undefined":"null"}. Using empty array instead.`),e=[]),l&&"object"==typeof e&&!Array.isArray(e)){t=[];for(const n in e)e.hasOwnProperty(n)&&!n.startsWith("$")&&t.push({__key:n,__value:e[n],__isObjectEntry:!0})}else Array.isArray(e)?t=e:(this.log("debug",`Warning: Expression "${a}" must return an array, got ${typeof e}. Converting to array.`),t=Array.isArray(e)?e:e?[e]:[]),this.proxyArrayMethods(t,n,d);return h&&(t=this.applyFilter(t,h,n,l)),g&&(t=this.applySort(t,g,n,l)),this.updateDOM(m,t,n,i,s,l,d),this.lightBind.digest&&"function"==typeof this.lightBind.digest&&setTimeout(()=>this.lightBind.digest(n),0),{success:!0,skipChildren:!0}}),{success:!0,skipChildren:!0}}updateDOM(e,t,n,o,r,i,s){const{parent:a,template:c,instances:l}=e,d=t.length,u=l.length,p=Math.min(d,u);for(let e=0;e<p;e++){const n=l[e],s=t[e];this.updateItemScope(n.component.scope,s,e,o,r,i,t.length)}if(u>d)for(let e=u-1;e>=d;e--){const t=l[e];t.component&&t.component.destroy&&t.component.destroy(),t.element&&t.element.parentNode&&t.element.parentNode.removeChild(t.element),l.pop()}if(d>u){const p=document.createDocumentFragment();for(let a=u;a<d;a++){const d=t[a],u=this.createItemScope(n,d,a,o,r,i,s,t.length),f=c.cloneNode(!0),h=this.createRepeatItemComponent(f,u,n,a,e.repeatId);this.lightBind.components.set(f,h),this.lightBind.elementToComponent.set(f,h),n.childComponents.push(h),this.lightBind.processElementAndChildren(f,h),this.lightBind.virtualDOM&&this.lightBind.virtualDOM.processTextNodes(f,h,u),l.push({element:f,component:h}),p.appendChild(f)}a.appendChild(p)}}createItemScope(e,t,n,o,r,i,s,a){const c=Object.create(e.scope);return i&&t.__isObjectEntry?(c[r]=t.__key,c[o]=t.__value,c.$index=n):(c[o]=t,c[r]=n,c.$index=n),c.$first=0===n,c.$last=n===a-1,c.$middle=!c.$first&&!c.$last,c.$even=n%2==0,c.$odd=!c.$even,this.log("debug",`Created scope for item ${n}, $index=${c.$index}, ${r}=${c[r]}`),Object.defineProperties(c,{$parentComponent:{value:e,enumerable:!1,configurable:!0},$parent:{value:e.scope,enumerable:!1,configurable:!0},$sourceArray:{value:s,enumerable:!0,configurable:!0}}),c}updateItemScope(e,t,n,o,r,i,s){i&&t.__isObjectEntry?(e[r]=t.__key,e[o]=t.__value,e.$index=n):(e[o]=t,e[r]=n,e.$index=n),e.$first=0===n,e.$last=n===s-1,e.$middle=!e.$first&&!e.$last,e.$even=n%2==0,e.$odd=!e.$even}applyFilter(e,t,n,o){return"function"==typeof n.scope[t]?e.filter(e=>{try{return o&&e.__isObjectEntry?!!n.scope[t](e.__value,e.__key):!!n.scope[t](e)}catch(e){return this.log("error",`Error executing filter function: ${e.message}`),!0}}):e.filter(e=>{try{const r={...n.scope};return o&&e.__isObjectEntry?(r.key=e.__key,r.value=e.__value,r.item=e.__value):r.item=e,!!this.lightBind.evaluateExpression(t,r)}catch(e){return this.log("error",`Error evaluating filter expression: ${e.message}`),!0}})}applySort(e,t,n,o){const r=[...e];if("function"==typeof n.scope[t])return r.sort((e,r)=>{try{return o?n.scope[t](e.__value,r.__value,e.__key,r.__key):n.scope[t](e,r)}catch(e){return this.log("error",`Error executing sort function: ${e.message}`),0}});if("object"==typeof n.scope[t]&&null!==n.scope[t])return r.sort((e,r)=>this.compareByCriteria(o?e.__value:e,o?r.__value:r,n.scope[t]));const i=this.parseSortCriteria(t);return Object.keys(i).length>0?r.sort((e,t)=>this.compareByCriteria(o?e.__value:e,o?t.__value:t,i)):r}compareByCriteria(e,t,n){const o=Object.entries(n).sort((e,t)=>Math.abs(e[1])-Math.abs(t[1]));for(const[n,r]of o){const o=this.lightBind.getNestedProperty(e,n),i=this.lightBind.getNestedProperty(t,n);if(o!==i)return r<0?this.compareValues(i,o):this.compareValues(o,i)}return 0}compareValues(e,t){return"string"==typeof e&&"string"==typeof t?e.localeCompare(t):e<t?-1:e>t?1:0}parseSortCriteria(e){const t={};try{const n=e.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);for(const e of n){const[n,o]=e.split(":").map(e=>e.trim());if(n&&o){const e=parseInt(o,10);isNaN(e)||(t[n]=e)}}}catch(e){this.log("error",`Error parsing sort criteria: ${e.message}`)}return t}}class S extends v{process(e,t,n){const o=this.lightBind.parseComplexExpression(t);if("object"===o.type){const t={};o.pairs.forEach(o=>{const{attribute:r,expression:i}=o;this.lightBind.createWatcher(n,i,o=>{const i=null==o?"":o;t[r]=i,n.updateProperty(e,"style",t)})})}else this.log("warn","bind-style should be an object",t),this.lightBind.createWatcher(n,t,t=>{try{"object"==typeof t&&null!==t?n.updateProperty(e,"style",t):null==t&&n.updateProperty(e,"style",{})}catch(e){this.log("error","Error setting styles",e)}});return{success:!0}}}class B extends v{constructor(e){if(super(e),!document.getElementById("bind-upload-styles")){const e=document.createElement("style");e.id="bind-upload-styles",e.textContent="\n        /* Styles for bind-upload directive */\n        .bind-upload-zone {\n          position: relative;\n          display: block;\n        }\n        \n        .bind-upload-zone.default-style {\n          border: 2px dashed #ccc;\n          border-radius: 8px;\n          padding: 20px;\n          text-align: center;\n          transition: all 0.2s ease;\n        }\n        \n        .bind-upload-zone.drag-active {\n          border-color: #007bff;\n          background-color: rgba(0, 123, 255, 0.05);\n        }\n        \n        .bind-upload-zone .hidden-drop-layer {\n          position: absolute;\n          top: 0;\n          bottom: 0;\n          left: 0;\n          right: 0;\n          z-index: 9999;\n          background: rgba(240, 240, 240, 0.6);\n          display: none;\n          pointer-events: none;\n        }\n        \n        .bind-upload-zone .file-select {\n          color: #007bff;\n          text-decoration: underline;\n          cursor: pointer;\n        }\n        \n        .bind-upload-zone.default-style .file-select:hover {\n          color: #0056b3;\n        }\n      ",document.head.appendChild(e)}}process(e,t,n){let o=this.lightBind;o.log("debug",`Setting up bind-upload with handler: ${t}`);const r="true"===e.getAttribute("multiple"),i="false"!==e.getAttribute("drag"),s="false"!==e.getAttribute("fileselect"),a=e.getAttribute("file-size-limit")?parseInt(e.getAttribute("file-size-limit")):null,c="true"===e.getAttribute("read-as-text"),l=e.getAttribute("data"),d=document.createElement("input");d.type="file",d.multiple=r,d.style.display="none",e.appendChild(d);const u=document.createElement("div");u.className="hidden-drop-layer",e.appendChild(u),e.classList.add("bind-upload-zone");let p=null;const f=e=>{const r=[];!function i(s){if(s>=e.length){const e=l?o.evaluateExpression(l,n.scope):null;return void(n.scope[t]&&(n.scope[t](r,e),o.digest(n)))}const d=e[s];if(a&&d.size>1e6*a)return o.log("warn",`File size exceeds limit of ${a}MB: ${d.name}`),void i(s+1);const u=new FileReader;u.onload=function(){const e=c?u.result:new Uint8Array(u.result),t={filename:d.name,shortName:d.name.replace(/\.[^/.]+$/,""),extension:d.name.split(".").pop(),size:d.size,mimetype:d.type,content:e};r.push(t),i(s+1)},u.onerror=function(){o.log("error",`Error reading file: ${d.name}`),i(s+1)}.bind(this),c?u.readAsText(d):u.readAsArrayBuffer(d)}(0)};return setTimeout(function(){p=e.querySelector(".file-select"),d.addEventListener("change",function(){f(d.files),d.value=""}),p?p.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),d.click()}):s&&e.addEventListener("click",function(){d.click()}),i&&(()=>{let t=!1;e.addEventListener("dragstart",function(){t=!0}),e.addEventListener("dragend",function(){t=!1}),e.addEventListener("dragenter",function(n){n.preventDefault(),n.stopPropagation(),t||(u.style.display="block",e.classList.add("drag-active"))}),e.addEventListener("dragleave",function(t){t.preventDefault(),t.stopPropagation();const n=e.getBoundingClientRect(),o=t.clientX,r=t.clientY;(o<=n.left||o>=n.right||r<=n.top||r>=n.bottom)&&(u.style.display="none",e.classList.remove("drag-active"))}),e.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),e.addEventListener("drop",function(n){n.preventDefault(),n.stopPropagation(),u.style.display="none",e.classList.remove("drag-active"),!t&&n.dataTransfer.files&&n.dataTransfer.files.length>0&&f(n.dataTransfer.files)})})()},0),{success:!0}}}class k extends v{process(e,t,n){if(!("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName))return this.log("warn",`Two-way binding can only be applied to input elements: ${e.tagName}`),{success:!1};this.log("dom",`Setting up two-way binding for ${e.tagName} with "${t}"`);const i=function(e){return!e||"checkbox"!==e.type&&"radio"!==e.type&&"SELECT"!==e.tagName?"input":"change"}(e),s=this;function a(t){try{r(e,t)}catch(e){s.log("error",`Error updating input element with ${t}:`,e)}}e.addEventListener(i,function(r){const i=o(e);try{s.log("event",`Two-way binding triggered, updating ${t} to:`,i),s.lightBind.setNestedProperty(n.scope,t,i),s.lightBind.digest(n)}catch(e){s.log("error",`Error updating property ${t}:`,e)}});return a(this.lightBind.getNestedProperty(n.scope,t)),this.lightBind.createWatcher(n,t,a),e.__lb_two_way_binding=!0,this.log("dom",`Two-way binding established for "${t}"`),{success:!0}}}function O(r={}){const i=new Map,s=new Map,a=new Map,m=new WeakMap,y=r.debug||!1;let v=!1;const O=r.dialogsPath||"../dialogs",_=r.componentsPath||"../components";let D=!1;const M=(e,...t)=>function(e,t,...n){if(e){t=t||"default";const e=`[LightBind][${(new Date).toISOString().substring(11,23)}][${t}]`,o={event:"color: #9933cc",digest:"color: #33cc33",dom:"color: #3399ff",init:"color: #ff9900; font-weight: bold",debug:"color: #33ccff"}[t]||"color: #666666";"error"===t?(console.error(e,...n),n.length>0&&n[n.length-1]instanceof Error?console.error(n[n.length-1].stack):console.error((new Error).stack)):"warn"===t?console.warn(e,...n):console.log(`%c${e}`,o,...n)}}(y,e,...t),P={"on-click":"click","on-change":"change","on-input":"input","on-submit":"submit","on-blur":"blur","on-double-click":"dblclick","on-middle-click":"auxclick","on-right-click":"contextmenu","on-focus":"focus","on-keyup":"keyup","on-keydown":"keydown","on-keypress":"keypress","on-mouseover":"mouseover","on-mouseout":"mouseout","on-mouseenter":"mouseenter","on-mouseleave":"mouseleave"},j={components:i,templateCache:s,repeatMarkers:a,elementToComponent:m,debug:y,digestScheduled:v,dialogsPath:O,componentsPath:_,log:M,isEqual:c,deepClone:l,copy:l,getNestedProperty:d,http:f(r),storage:g,notification:h,eventMap:P};function R(e){e?(M("init","LightBind initializing, searching for components"),e.querySelectorAll("[bind-function]").forEach(e=>{M("init","Found initial component",e.getAttribute("bind-function")),W(e)}),window.renderComponent=j.renderComponent,M("init","LightBind initialization complete")):M("error","LightBind initialization failed: Root element not found")}function L(e){let t=e.parentElement;for(;t;){if(m.has(t))return m.get(t);t=t.parentElement}return null}function I(e){if(m.has(e))return m.get(e);for(const t of i.values()){if(t.element===e)return t;if(t.isRepeatItem&&t.elements&&(t.elements.includes(e)||t.element.contains(e)))return t}return L(e)}function z(e,t,n,r){r.nodeBindings.has(e)||r.nodeBindings.set(e,{});const i=r.nodeBindings.get(e),s=j.parseInterpolatedString(n);if(s.some(e=>e.expression)){i.attributes||(i.attributes={}),i.attributes[t]={original:n,parts:s,lastValue:null};const o=()=>{let n="";s.forEach(e=>{if(e.expression){const t=j.evaluateExpression(e.text,r.scope);n+=null!=t?t:""}else n+=e.text}),i.attributes[t].lastValue!==n&&(r.updateProperty(e,t,n),i.attributes[t].lastValue=n)};s.filter(e=>e.expression).forEach(e=>{j.createWatcher(r,e.text,o)}),o()}if("INPUT"===e.tagName&&"bind"===t){const t=n.trim();if(t in r.scope){if("number"===e.type&&"number"!=typeof r.scope[t]){const e=Number(r.scope[t]);r.scope[t]=isNaN(e)?0:e}}else r.scope[t]=o(e);j.virtualDOM.createFromDOM(e,r)}}function F(e,t,n,r){r.nodeBindings.has(e)||r.nodeBindings.set(e,{});const i=r.nodeBindings.get(e),s=`event_${t}_${n}`;if(i[s])return;const a="INPUT"===e.tagName||"SELECT"===e.tagName||"TEXTAREA"===e.tagName;a&&("checkbox"===e.type||e.type);const c=I(e),l=s=>{let l=!0;if(("input"===t||"change"===t)&&a){const n=j.virtualDOM.nodeMap.get(e);n&&(n.value={type:e.type||"text",value:o(e),checked:"checkbox"===e.type||"radio"===e.type?e.checked:void 0},n.isDirty=!0);const r=o(e);r===i[`lastValue_${t}`]?l=!1:i[`lastValue_${t}`]=r}if(l){const e=(c||r).scope;e.$event=s,j.parseEventHandler(n,e,s),j.digest(c||r)}};!a||"input"!==t&&"change"!==t||(i[`lastValue_${t}`]=o(e)),e.addEventListener(t,l),i[s]=l}function q(e,t,n=!1){if(t.nodeBindings.has(e)&&t.nodeBindings.get(e).processed)return;if(e.hasAttribute("bind-function")&&e!==t.element)return;t.nodeBindings.set(e,{processed:!0});let o=!1;if(t.bindings=t.bindings||[],"INPUT"!==e.tagName&&"SELECT"!==e.tagName&&"TEXTAREA"!==e.tagName||j.virtualDOM.createFromDOM(e,t),e.hasAttribute("bind-repeat")){const n=e.getAttribute("bind-repeat"),o=j.directives["bind-repeat"].process(e,n,t);if(o&&o.scopes&&(t.repeatScopes||(t.repeatScopes=[]),t.repeatScopes.push(...o.scopes),o.items&&o.items.length>0&&o.scopes.forEach((e,n)=>{o.items[n]&&(Object.getOwnPropertyDescriptor(e,"$parent")||Object.defineProperty(e,"$parent",{value:t.scope,enumerable:!1,configurable:!0}),Object.getOwnPropertyDescriptor(e,"$elem")||Object.defineProperty(e,"$elem",{value:o.items[n],enumerable:!1,configurable:!0}))})),o&&o.skipChildren)return}Array.from(e.attributes||[]).forEach(n=>{const r=n.name,i=n.value;if("bind-repeat"!==r)if(P[r])F(e,P[r],i,t);else if(j.directives[r]){const n=j.directives[r].process(e,i,t);"bind-if"===r&&(o=n.skipChildren||!1)}else i.includes("{{")&&z(e,r,i,t)}),t.nodeBindings.set(e,{processed:!0,fullyProcessed:!0}),n||o||Array.from(e.children).forEach(e=>{t.nodeBindings.has(e)&&t.nodeBindings.get(e).processed||q(e,t)})}function V(e){const t=[e.element];e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{t.includes(e)||t.push(e)});const n=o=>{o&&e.nodeBindings.has(o)&&(t.includes(o)||t.push(o)),o.children&&Array.from(o.children).forEach(n)};return n(e.element),t}function W(e,t,o={}){if(m.has(e))return m.get(e);const r=L(e),s={},c={element:e,scope:s,childComponents:[],parent:r,nodeBindings:new WeakMap,textNodeRegistry:{},watcherRegistry:{},updateProperty:function(e,t,n){this.nodeBindings.has(e)||this.nodeBindings.set(e,{});const o=this.nodeBindings.get(e);if(o.managedProps||(o.managedProps={}),o.managedProps[t]=n,"class"===t)e.className=n;else if("style"===t&&"object"==typeof n)Object.entries(n).forEach(([t,n])=>{e.style[t]=n});else if("value"===t){if("INPUT"===e.tagName||"TEXTAREA"===e.tagName)e.value=n;else if("SELECT"===e.tagName){e.value=n;for(let t=0;t<e.options.length;t++)if(e.options[t].value===n){e.selectedIndex=t;break}}}else"checked"===t&&"INPUT"===e.tagName?e.checked=!!n:e.setAttribute(t,n);return this},destroy:function(){M("lifecycle",`Destroying component at ${e.tagName}#${e.id||"unknown"}`);[...this.childComponents].forEach(e=>{e&&"function"==typeof e.destroy&&e.destroy()}),this.childComponents=[],this.watcherRegistry={};if(V(this).forEach(e=>{if(!e)return;const t=this.nodeBindings.get(e);if(t)for(const n in t)if(n.startsWith("event_")){const[o,r]=n.split("_",2);"function"==typeof e.removeEventListener&&"function"==typeof t[n]&&(e.removeEventListener(r,t[n]),M("cleanup",`Removed event handler ${r} from element`))}this.nodeBindings.delete(e),m.delete(e)}),this.isRepeatItem&&a.forEach((e,t)=>{if(e.instances&&e.instances.includes(this)){const t=e.instances.indexOf(this);-1!==t&&e.instances.splice(t,1)}}),i.delete(this.element),this.parent){const e=this.parent.childComponents.indexOf(this);-1!==e&&this.parent.childComponents.splice(e,1)}for(const e in this.scope)this.scope[e]=null;if("function"==typeof this.scope.$onDestroy)try{this.scope.$onDestroy()}catch(e){M("error","Error in $onDestroy callback:",e)}j.virtualDOM.cleanupComponent(this),M("lifecycle","Component destroyed successfully.")}};i.set(e,c),m.set(e,c),r&&(r.childComponents.push(c),Object.setPrototypeOf(s,r.scope),Object.defineProperty(s,"$parent",{value:r.scope,enumerable:!1,configurable:!0})),Object.defineProperty(s,"$elem",{value:e,enumerable:!1,configurable:!0}),s.$render=(e={})=>(e&&"object"==typeof e&&Object.assign(s,e),j.digest(c),s),s.$refresh=()=>(j.digest(c),r&&j.digest(r),s),s.$onInit=s.$onInit||function(){},s.$onDestroy=s.$onDestroy||function(){},s.$findBinding=n(e);let l=t?.name||e.getAttribute("bind-function");!t&&l&&"function"==typeof window[l]&&(t=window[l]);const d={};Array.from(e.attributes||[]).forEach(e=>{d[e.name]=e.value}),c.strategy=e.getAttribute("bind-strategy")||"default",q(e,c),j.virtualDOM.processTextNodes(e,c),j.virtualDOM.createFromDOM(e,c),o=o||{},["elem","attrs","bindings"].forEach(e=>{o[e]&&(console.warn(`LightBind: Input property '${e}' is reserved and will be renamed to '_${e}'`),o["_"+e]=o[e],delete o[e])});try{t(s,{elem:e,attrs:d,bindings:c.bindings,...o}),"function"==typeof s.$onInit&&s.$onInit(),e.classList.add("lb-initialized"),setTimeout(()=>{if(c.watcherRegistry){const e=new Set;Object.values(c.watcherRegistry).forEach(t=>{t.forEach(t=>{if(!e.has(t)){e.add(t);try{t()}catch(e){M("error","Error running initial watcher:",e)}}})})}j.digest(c)},0)}catch(t){e.classList.add("lb-initialized"),M("error",`Error executing function ${l}:`,t)}return c}function U(e,t){if(!e||!e.watcherRegistry)return;const n=new Set,o=t.split(".");let r="";for(let t=0;t<o.length;t++){r=0===t?o[t]:`${r}.${o[t]}`;const i=e.watcherRegistry[r];i&&i.forEach(e=>{n.has(e)||(n.add(e),e())})}Object.keys(e.watcherRegistry).forEach(o=>{if(o.startsWith(t+".")){const t=e.watcherRegistry[o];t&&t.forEach(e=>{n.has(e)||(n.add(e),e())})}}),e.textNodeRegistry[r].forEach(({update:e})=>{n.has(e)||(n.add(e),e())})}return j.dialog=p(j),Object.assign(j,t(j),e(j)),j.virtualDOM=b(j),j.directives={bind:new k(j),"bind-attr":new x(j),"bind-class":new E(j),"bind-component":new w(j),"bind-html":new N(j),"bind-if":new A(j),"bind-repeat":new T(j),"bind-style":new S(j),"bind-drag":new $(j),"bind-drop":new C(j),"bind-upload":new B(j)},j.digest=function(e=null){v||(v=!0,queueMicrotask(()=>{const t=performance.now();if(e){j.virtualDOM.updateComponent(e);const t=j.updateComponentTree(e);e.parent&&t.changesDetected>0&&j.virtualDOM.updateComponent(e.parent)}else j.components.forEach(e=>{j.virtualDOM.updateComponent(e),j.updateComponent(e)});j.virtualDOM.applyChanges();const n=(performance.now()-t).toFixed(2);M("digest",`Digest cycle complete in ${n}ms`),v=!1}))},Object.assign(j,{setGlobals:function(){const e={LightBind:j,storage:j.storage,http:j.http,dialog:j.dialog,notification:j.notification,copyToClipboard:u};return JSON.copy||(JSON.copy=j.deepClone),Object.assign(window,e),j},start:function(e){if(e){R("string"==typeof e?document.querySelector(e):e)}else"loading"===document.readyState?(document.addEventListener("DOMContentLoaded",()=>{R(document.body)}),setTimeout(()=>{D||(M("init","Using fallback initialization"),R(document.body),D=!0)},4e3)):R(document.body);return j},handleDOMChanges:function(e){for(const t of e)"attributes"===t.type&&"bind-function"===t.attributeName?W(t.target):"childList"===t.type&&t.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(e.hasAttribute("bind-function")&&W(e),e.querySelectorAll("[bind-function]").forEach(e=>W(e)))})},initializeComponent:W,findParentComponent:L,processElementAndChildren:q,setupAttributeBinding:z,setupEventBinding:F,findDirectComponentForElement:I,setupToggleVisibleWatcher:function(e,t){if(e.toggleVisibleWatcherCreated)return;let n=e.scope.toggleVisible;e.watcherRegistry||(e.watcherRegistry={}),e.watcherRegistry.toggleVisible||(e.watcherRegistry.toggleVisible=[]),e.watcherRegistry.toggleVisible.push(()=>{const o=e.scope.toggleVisible;if(n!==o){const e=n;return n=o,t(o,e),!0}return!1}),e.toggleVisibleWatcherCreated=!0},findComponentForScope:function(e){for(const t of i.values()){if(t.scope===e)return t;if(t.repeatScopes)for(const n of t.repeatScopes)if(n===e)return t}return null},getAllBoundElements:V,triggerPropertyWatchers:U,setNestedProperty:function(e,t,n){try{const o=t.split("."),r=o.pop();let i=e;for(const e of o)void 0!==i[e]&&null!==i[e]||(i[e]={}),i=i[e];i[r]=n;const s=j.findComponentForScope(e);return s&&U(s,t),!0}catch(e){return M("error",`Error setting nested property ${t}:`,e),!1}}}),j}class _{constructor(e={}){const t=O(e);Object.assign(this,t)}}export{_ as LightBind};
